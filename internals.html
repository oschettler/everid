---
title: EverID - The Internals
layout: default
tags: 
res: 
  3d8d3ef1bcf680c792c58a51fba8b50d: res/195f5004-2e6e-4bb6-8dcb-d3d82a2e6df1.png
  4f17191649c326476fc6aa772aff3f17: res/aa4e1bd0-5ecd-4e71-94ed-339e43e273fa.png
---

<h1>{{ page.title }}</h1>
		  		<div>
<ul>
<li><a href="https://github.com/noodlehaus/dispatch">dispatch.php</a> for routing and overall structure</li>
<li><a href="https://github.com/j4mie/idiorm">idiorm </a>to access an SQlite database</li>
<li>client libraries for both <a href="https://dev.evernote.com/doc/reference">Evernote </a>and <a href="https://developer.github.com/v3/">Github </a>to access there APIs</li>
<li>an SQlite database to store the information entered on https://everid.net for account and site configuration</li>
</ul>
<div><b>Routing</b></div>
<div><br/></div>
<div>The sole entry point into the site is the file index.php. From here, the various resources are dispatched:</div>
<div>
<ul>
<li>/ - The site’s landing page</li>
<li>/webhook - Called by Evernote when an update to a registered notebook has to be processed</li>
<li>/user - Editing a user’s property and sites</li>
<li>/auth - Authenticating against Evernote</li>
<li>/github - Authenticating against Github</li>
<li>/contact - A small contact form<br/></li>
</ul>
<div><b>Authentication</b></div>
</div>
<div><br/></div>
<div>Authentication on EverID is via the Evernote service. A single Evernote user may register multiple sites to be rendered from an Evernote notebook.</div>
<div><br/></div>
<div><b>Rendering</b></div>
<div><br/></div>
<div>Rendering happens in the file update.php and is triggered by a call to the endpoint /webhook. Evernote passes a set of parameters when calling this address:</div>
<div>
<ul>
<li>userId</li>
<li>notebookGuid</li>
</ul>
</div>
<div>From these parameters the owner and site to be rendered are retrieved and fed to the function update() which does the actual rendering to Github.</div>
<div><br/></div>
<div>First, a connection to the Github API is established, using the Github authentication token, username and repository name as parameters. Then, if necessary, a branch <b>gh-pages</b> is created. </div>
<div><br/></div>
<div>Next, another remote connection is established, this time to the Evernote API, and the list of notebooks for the authenticated Evernote user is traversed. Once the notebook with the matching notebookGuid is found, some house-keeping is done for creating the necessary site blueprint for a <a href="http://jekyllrb.com/">Jekyll site</a> at Github:</div>
<div>
<ul>
<li>Check, and - if necessary - create directories</li>
<li>Create a directory for design (=theme) files</li>
<li>Create files for the general page layout and CSS styles</li>
<li>If requested, create the CNAME file for a custom domain</li>
<li>Extract the configuration and navigation items from the site outline</li>
</ul>
<div>Then, the notes in the notebook are traversed. The page address of each note is determined either from the sourceURL or a tag with the prefix „url:" or „url=" . This is so that notes entered on the Evernote mobile client can also be rendered, where this client does not offer a sourceURL field.</div>
</div>
<div><br/></div>
<div>Next, images are extracted from the note and written to Github.</div>
<div><br/></div>
<div>Finally, the HTML of the note is rendered, prefixed by a preamble with title, layout name, tag list, and list of resources (i.e. images or attachments). During rendering, image references are replaced with proper HTML tags.</div>
<div><br/></div>
<div>To check the rendering, you can leave your email address on the site</div>
<div><br/></div>
<div><span><img src="res/aa4e1bd0-5ecd-4e71-94ed-339e43e273fa.png"/></span><br/></div>
<div><br/></div>
<div>... and get a log of the rendering steps. Please make sure to check your spam folder as well. I have not yet had time to properly set all the email headers.</div>
<div><br/></div>
<div><span><img src="res/195f5004-2e6e-4bb6-8dcb-d3d82a2e6df1.png"/></span><br/></div>
<div><br/></div>
</div>

